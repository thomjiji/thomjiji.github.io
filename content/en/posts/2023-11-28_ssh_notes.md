---
title: "SSH notes"
date: 2023-11-28
draft: false
tags: ["SSH"]
slug: ssh-notes
isCJKLanguage: true
---

SSH 是一个我之前就想尝试使用的工具，当时只有对它的一个很简单的印象，就是可以通过它安全的访问另外一台电脑——的 Terminal。当然对它的具体原理和运行逻辑肯定是不了解的，包括它是怎么个安全法。只知道哦我可以通过它访问到比如说，当我自己打开 Terminal 时候首先展示在我面前的那一堆东西，其实就是在 $HOME directory 你输入比如 `ls -al` 命令出现的各个 directory。只是我可以看到另一台设备的这一堆东西。那当时这个需求也是没有那么强烈，所以就还是暂时搁置没有了解。

但 SSH 应该是程序开发必备的技能之一吧？就跟 Git 一样。又加上我最近（又）在尝试 Asahi Linux，准确说应该是 [Fedora Asahi Remix](https://asahilinux.org/)，在我的 Mac mini 2020 款之上。然后在 Linux 上，也没办法继续使用 macOS 上那一套打包方案，比如 iCloud、Keychain 之类。尤其是 Keychain，虽然我其实主要还是使用 Bitwarden 来管理密码，但是 Keychain 也会用。那首先迁移到 Fedora Asahi Remix，就需要把之前在 macOS 上那一系列账号认证的东西，包括密码什么的迁移过来。这时又想起去年年底研究过一阵子的 GPG key 和一个非常简洁好用的命令行密码管理工具 [pass](https://www.passwordstore.org/)——它就是使用 GPG key 来加密的。正好对 GPG 相关的知识又有点模糊了，正好一块补习一下。

Ok，扯了这么多究竟又是怎么跟 SSH 联系到一起了呢？就是我需要在我的 MBP 和 Fedora Asahi Remix 上拷贝来拷贝去一些文件、字体和配置文件。当然我也尝试过就使用简单的局域网互投的工具，像最早我使用的 [LANDrop](https://landrop.app/)，还有 KDE Connect。LANDrop 呢，之前我用 Linux 的时候（拥有过一阵子 ThinkPad）确实没什么问题，用的挺好的，手机电脑之间传文件都挺方便，也就没有去想我要用 SSH，LANDrop 已经满足我需求了。但是好像 ARM64 的版本它没有支持太好，我记得刚装好 Fedora Asahi Remix 的时候，我下载它的 AppImage 打开直接闪退，根本用不了。后者 KDE Connect 呢，电脑从来都搜不到手机，手机也搜不到电脑。当然官方有提供一些 [troubleshooting 的方法](https://userbase.kde.org/KDEConnect#Troubleshooting)，而我也确实有一次做了一些操作成功让它们搜到对方了。但下次又不行了，所以我还是干脆放弃使用了。

终于，这也不行那也不行，我不得不要看一下这个 SSH 了，我最初级的需求真的就是两台电脑可以在局域网内传个文件，再高一点就是我可以真正把 SSH 用起来，自由的 ssh in 到我身边的任何一台（属于我的）电脑，exit，然后 ssh in 到下一台，自由的访问各个电脑的 $HOME directory。你能到达另一台电脑的 $HOME directory 意味着你可以访问到几乎所有你想要的配置文件也好，一些日常的截图、视频啦之类的，都可以哎。像是打破不同电脑之间物理的界限，一种自由的感觉。所以，教练，我要学这个！

---

**生成一个 SSH key:**

最简单的生成一个 ssh key 的方法：`ssh-keygen -C "my ssh key"`

- `-c`: comment. Provides a comment for this key.

较常用的生成一个 ssh key 的方法（自定义 key 的类型/算法）：`ssh-keygen -t ed25519 -C "my ssh key"`

- `-t`: Specify the type of the key to create. The possible values are “dsa”, “ecdsa”, “ecdsa-sk”, “ed25519”, “ed25519-sk”, or “rsa”..

---

SSH 协议有多种认证（authentication）方式，其中一种最安全的，也是最常使用的，就是 public key authentication。与另一个叫作 authentication agent (ssh-agent) 的东西搭配使用，可以在比如你需要 login 多台电脑的情况下，省去输入多个密码的功夫。

你把你 local machine 的 ssh key 的 public key，public 的部分发给 remote machine。然后在 local machine 上运行 ssh-agent，把你的 private key，private 的部分加载/添加给 ssh-agent——具体则是使用 ssh-add 这个程序来做“加载/添加”这件事情。当然，添加给 ssh-agent 的时候需要输入你 private key 的 passphrase。

这样之后，ssh-agent 就拿着你的 private key，默默运行在后台。等到你想要 login 其他电脑的时候，它会出来向其他电脑证明你真的是你（通过你的 private key 来证明。因为它把持着你的 private key，所以它能够帮你证明你是你）——不用担心，private key 只存储在内存中而已。


---

Public Key Access:
- A user creates a pair of public and private keys, and installs the public key in his **$HOME/.ssh/authorized_keys** file on the target server. 然后这个 public key 对应的 private key 的所有者（的设备/machine）就可以访问这个 target server 了。
- A public key consist of:
	- type
	- key (itself)
	- comment
	- For example: `ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEMucCYHaP8lU+zBeeP6ps7DsT7ViZCvWK1UOiaNaSyg mbp`

Public Key Access with Agent support: ...

Public Key Access with Agent Forwarding: ...

---

**authorized_keys:**

User: The "authorized_keys" file on the remote server is used for manage "who" can access to that server, right?

ChatGPT: Exactly, that's correct. The `authorized_keys` file on the remote server is used to manage access by specifying which public keys are allowed to connect to a particular user's account on that server. Each line in the `authorized_keys` file typically represents a public key that is authorized to access the associated user account. By adding or removing public keys in this file, administrators can control and manage who has permission to log in to the server using SSH.

> The file `~/.ssh/authorized_keys` lists the public keys that are permitted for logging in. When the user logs in, the ssh program tells the server which key pair it would like to use for authentication. The client proves that it has access to the private key and the server checks that the corresponding public key is authorized to accept the account. — `man ssh` | AUTHENTICATION

---

如果我尝试 access 一台 remote server，但我本地没有配置任何 ssh key，`.ssh` 文件夹都是空的。这个时候 authentication **fall back** 为 username/password access。你需要输入 remote server 的 login password 来 ssh in。

---

- `ssh-add`: Add ssh private key to ssh-agent。让 ssh-agent 来保管我的 private key。这个命令需要你输入 ssh private key 的 passphrase。
- `ssh-add -l`: Lists fingerprints of all identities currently represented by the agent. 列出当前被添加到 ssh-agent 的 ssh (private) key 的 fingerprint。

---

`SSH_AUTH_SOCK` environment variable: Identifies the path of a UNIX-domain socket used to communicate with the agent.

储存在这个 environment variable 的是一个 socket 文件路径，这个 sokcet 文件用来 ssh client 和 ssh-agent 之间进行通信的。

---

所有可以在 `~/.ssh/config` 文件里设置的东西，都在 `man ssh_config` 里。

---

SSH authentication methods:

1. Host-based authentication:
   - 其他认证方式认证是 user，证明这个尝试 login 的 *user* (比如 Bob) 是值得信任的：这个 user 持有我 remote server 上 public key 所对应的 private key，因此他是可以信任的，放行。而 Host-based authentication 认证的是 user 所在的那台 machine，那台电脑本身是否值得信任。当 remote server 认证了那台电脑是可信的时候，如果那台电脑说：好，现在尝试连接到你那边的这个 user 我已经认证过了，那么 ssh server 就不再认证这个 user 了，它相信这台 machine。
2. Public key authentication
3. Keyboard-interactive authentication: The server sends an arbitrary "challenge" text and prompts for a response, possibly multiple times.
4. Password authentication

Password authentication 和 Public key authentication 在实际使用上乍一看好像差别不大，一个是输入 password，一个是输入 passphrase，都要输入一个什么东西。但实际上，Password authentication 的情况下，password 是直接传输给 remote host/server 的。而 Public key authentication 的情况下，你输入的 passphrase 只是用来 decrypt private key，来完成一个叫作 authenticator 的创建而已。你的 passphrase 和你的密钥 private key，都保持在本地的状态。

什么是 authenticator？

当 local 想要 login 到 remote 时，remote 给 local 发一个挑战。local 的 ssh client 用 remote 发给它的挑战（包含 public key 的一些成分）和自己的 private key，做成的那个东西就叫作 authenticator。然后这个东西发回给 remote server 来证明我确实是我。


---

To allow access for only specific users:

- Edit this file: `/etc/ssh/sshd_config`.
- Append `AllowUsers user1 user2` to it.

> ⬆️ This keyword can be followed by a list of user name patterns, separated by spaces.

More info can be fonud in sshd_config man page: `man sshd_config`.

---

SSH 的 known-host 机制可以防止[中间人攻击](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) man-in-the-middle attack。当你 local machine 的 ssh client（local 的 ssh program 我们叫它 client）想要和 remote 的 server 连接，不仅 local 的 client 需要向 remote server 证明你是你，remote server 同样也需要向 local client 证明它是它。remote 的 ssh server 也有一个 secret key，叫作 host key。它就是用 host key 来向 local 的 client 证明它是它的。

当你第一次连接 remote server，remote server host key 的 public 的部分，public key 会被复制并存储在 local machine （假设你在 local machine 尝试连接 remote 时弹出的确认添加公钥的提示中回答了“yes”，如下）——实际上就是存储在 `~/.ssh/known_hosts` 文件当中。每次重新连接 remote server 时，local 的 ssh 客户端都会使用存储在 known_hosts 文件当中的对应的 public key 来检查和确认 remote server 的身份。

这里有一个相关的设置叫作“StrictHostKeyChecking”，具体请看 `man ssh_config`。

```sh
Host key not found from the list of known hosts.
Are you sure you want to continue connecting (yes/no)?
```

---

local machine `~/.ssh/known_hosts` 里的 key，可以在 remote machine 的 `/etc/ssh/` directory 下面找到。`/etc/ssh` 下面有这些文件：

```sh
$ ls -l | awk "{print $NF}"
...
ssh_host_ecdsa_key
ssh_host_ecdsa_key.pub
ssh_host_ed25519_key
ssh_host_ed25519_key.pub
ssh_host_rsa_key
ssh_host_rsa_key.pub
```

每个 `.pub` 文件里的内容都对应着 known_hosts 文件里的一行。

---

> ssh automatically maintains and checks a database containing **identification for all hosts it has ever been used with**. Host keys are stored in `~/.ssh/known_hosts` in the user's home directory.

> Any new hosts are automatically added to the user's file (`~/.ssh/known_hosts` file).

— `man ssh` | AUTHENTICATION

---

Permission

`~/.ssh`: This directory i sthe default location for all user-specific configuration and authentication information. **There is not general requirement to keep the entire contents of this directory secret, but the recommended permissions are read/write/execute for the user, and not accessible by others.**

To learn more about permissions for files in `.ssh` folders, please see `man sshd` > FILES. This section contains the descriptions about the `~/.ssh`, `/etc/ssh` directories and the files under them, what they are used for, etc.

## Reference

- [An Illustrated Guide to SSH Agent Forwarding](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html)
- [OpenSSH - Arch Wiki](https://wiki.archlinux.org/title/OpenSSH)
- https://infosec.mozilla.org/guidelines/openssh
- `man sshd`
- `man sshd_config`
- `man ssh`
